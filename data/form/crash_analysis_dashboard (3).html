<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Henrico County Traffic Engineering - Crash Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #1e3c72;
            --primary-light: #2a5298;
            --bg-light: #f5f7fa;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --severity-fatal: #dc3545;
            --severity-serious: #fd7e14;
            --severity-minor: #ffc107;
            --severity-possible: #17a2b8;
            --severity-pdo: #28a745;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }

        /* ===== HEADER SECTION ===== */
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            color: white;
            padding: 40px 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header-subtitle {
            font-size: 1.1em;
            opacity: 0.95;
            margin-bottom: 5px;
        }

        .header-meta {
            font-size: 0.95em;
            opacity: 0.85;
        }

        .header-branding {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 10px;
            font-style: italic;
        }

        /* ===== EXECUTIVE SUMMARY ===== */
        .executive-summary {
            background-color: #fff9e6;
            border-left: 5px solid #ffc107;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }

        .executive-summary h2 {
            color: var(--primary-dark);
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .executive-summary p {
            font-size: 1em;
            line-height: 1.7;
            color: #333;
        }

        .summary-metric {
            font-weight: bold;
            color: var(--primary-dark);
        }

        /* ===== KPI CARDS ===== */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            text-align: center;
        }

        .kpi-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .kpi-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .kpi-value.critical {
            color: var(--severity-serious);
        }

        .kpi-value.warning {
            color: var(--severity-minor);
        }

        /* ===== SECTION HEADERS ===== */
        .section-header {
            font-size: 1.5em;
            color: var(--primary-dark);
            font-weight: bold;
            margin: 35px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary-light);
        }

        /* ===== CHARTS CONTAINER ===== */
        .chart-container {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            position: relative;
            height: auto;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
            margin: 15px 0;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 15px;
            text-align: center;
        }

        /* ===== GRID LAYOUTS ===== */
        .two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .three-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-box {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        /* ===== TABLE STYLES ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--white);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .data-table thead {
            background-color: var(--primary-dark);
            color: white;
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .data-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== CRITICAL FINDING BOX ===== */
        .critical-finding {
            background-color: #ffe6e6;
            border-left: 5px solid #dc3545;
            padding: 25px;
            margin: 30px 0;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }

        .critical-finding h3 {
            color: #dc3545;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .critical-finding p {
            color: #333;
            font-size: 1em;
            line-height: 1.7;
        }

        /* ===== FOOTER ===== */
        .footer {
            background: var(--primary-dark);
            color: white;
            padding: 30px 25px;
            margin-top: 50px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .footer-content {
            line-height: 1.8;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .container {
                padding: 20px;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .two-column {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .kpi-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .kpi-value {
                font-size: 1.8em;
            }

            .chart-wrapper {
                height: 300px;
            }

            .three-column {
                grid-template-columns: 1fr;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
                font-size: 0.85em;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 15px 10px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .header-subtitle {
                font-size: 0.95em;
            }

            .kpi-container {
                grid-template-columns: 1fr;
            }

            .kpi-card {
                padding: 15px;
            }

            .kpi-label {
                font-size: 0.8em;
            }

            .kpi-value {
                font-size: 1.6em;
            }

            .section-header {
                font-size: 1.2em;
            }

            .chart-wrapper {
                height: 250px;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            body {
                background: white;
            }

            .header {
                background: var(--primary-dark);
                color: white;
                page-break-after: avoid;
            }

            .chart-container,
            .kpi-card,
            .chart-box,
            .executive-summary,
            .critical-finding {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }

            .section-header {
                page-break-after: avoid;
            }

            canvas {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER SECTION -->
        <div class="header">
            <div class="header-branding">Henrico County Traffic Engineering Division</div>
            <h1>VRA4437R CREL Crash Analysis Dashboard</h1>
            <div class="header-subtitle">Road Segment: VRA4437R CREL - Urban Intersection</div>
            <div class="header-meta">Analysis Period: July 2021 - January 2025 | Total Crashes: 31</div>
        </div>

        <!-- EXECUTIVE SUMMARY -->
        <div class="executive-summary">
            <h2>Executive Summary</h2>
            <p>This analysis examines <span class="summary-metric">31 crashes</span> that occurred on the VRA4437R CREL corridor in Henrico County over a <span class="summary-metric">3.5-year period (July 2021 - January 2025)</span>. The primary crash pattern is <span class="summary-metric">Angle collisions (45.2%)</span>, which account for approximately 14 crashes, followed by Rear-End collisions (22.6%). The crash severity profile shows <span class="summary-metric">0% fatal/serious injury (KA) rate</span>, with 67.7% of crashes classified as Property Damage Only (PDO) and the remaining 32.3% involving minor or possible injuries (B+C). The main safety concern is the concentration of <span class="summary-metric">90.3% of crashes occurring in clear, dry weather conditions</span>, indicating that geometric design factors, intersection configuration, traffic control devices, or driver behavior—rather than environmental hazards—are likely primary contributors to this crash pattern.</p>
        </div>

        <!-- KPI CARDS -->
        <div class="kpi-container">
            <div class="kpi-card">
                <div class="kpi-label">Total Crashes</div>
                <div class="kpi-value">31</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Crash Frequency</div>
                <div class="kpi-value">8.9</div>
                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">crashes/year</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">KA Crash Rate</div>
                <div class="kpi-value critical">0%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Injury Crash %</div>
                <div class="kpi-value warning">32.3%</div>
                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">K+A+B+C</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">RwD Percentage</div>
                <div class="kpi-value">0%</div>
                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Not RwD Defect</div>
            </div>
        </div>

        <!-- YEAR-BY-YEAR TREND SECTION -->
        <div class="section-header">Year-by-Year Trend Analysis</div>

        <div class="two-column">
            <div class="chart-box">
                <div class="chart-title">Total Crashes by Year</div>
                <div class="chart-wrapper">
                    <canvas id="yearlyTrendChart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <div class="chart-title">Crash Severity Breakdown by Year</div>
                <div class="chart-wrapper">
                    <canvas id="severityByYearChart"></canvas>
                </div>
            </div>
        </div>

        <!-- YEARLY STATISTICS TABLE -->
        <div class="chart-container">
            <div class="chart-title">Yearly Crash Statistics</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Total Crashes</th>
                        <th>Fatal (K)</th>
                        <th>Serious (A)</th>
                        <th>Minor (B)</th>
                        <th>Possible (C)</th>
                        <th>PDO</th>
                        <th>KA Rate (%)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>2021</strong></td>
                        <td>1</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>1</td>
                        <td>0</td>
                        <td>0.0%</td>
                    </tr>
                    <tr>
                        <td><strong>2022</strong></td>
                        <td>8</td>
                        <td>0</td>
                        <td>0</td>
                        <td>3</td>
                        <td>1</td>
                        <td>4</td>
                        <td>0.0%</td>
                    </tr>
                    <tr>
                        <td><strong>2023</strong></td>
                        <td>9</td>
                        <td>0</td>
                        <td>0</td>
                        <td>2</td>
                        <td>0</td>
                        <td>7</td>
                        <td>0.0%</td>
                    </tr>
                    <tr>
                        <td><strong>2024</strong></td>
                        <td>11</td>
                        <td>0</td>
                        <td>0</td>
                        <td>2</td>
                        <td>0</td>
                        <td>9</td>
                        <td>0.0%</td>
                    </tr>
                    <tr>
                        <td><strong>2025*</strong></td>
                        <td>2</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>2</td>
                        <td>0.0%</td>
                    </tr>
                    <tr style="background-color: #f0f0f0; font-weight: bold;">
                        <td><strong>TOTAL</strong></td>
                        <td>31</td>
                        <td>0</td>
                        <td>0</td>
                        <td>7</td>
                        <td>1</td>
                        <td>22</td>
                        <td>0.0%</td>
                    </tr>
                </tbody>
            </table>
            <div style="font-size: 0.85em; color: #666; margin-top: 10px;">*2025 data through January</div>
        </div>

        <!-- CRASH SEVERITY ANALYSIS -->
        <div class="section-header">Crash Severity Distribution</div>

        <div class="chart-container">
            <div class="chart-wrapper" style="height: 400px;">
                <canvas id="severityChart"></canvas>
            </div>
        </div>

        <!-- COLLISION TYPE ANALYSIS -->
        <div class="section-header">Collision Type Analysis</div>

        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="collisionTypeChart"></canvas>
            </div>
        </div>

        <!-- ENVIRONMENTAL CONDITIONS -->
        <div class="section-header">Environmental Conditions Analysis</div>

        <div class="three-column">
            <div class="chart-box">
                <div class="chart-title">Weather Conditions</div>
                <div class="chart-wrapper">
                    <canvas id="weatherChart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <div class="chart-title">Light Conditions</div>
                <div class="chart-wrapper">
                    <canvas id="lightChart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <div class="chart-title">Surface Conditions</div>
                <div class="chart-wrapper">
                    <canvas id="surfaceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- CRITICAL FINDING BOX -->
        <div class="critical-finding">
            <h3>⚠ Critical Finding</h3>
            <p><strong>90.3% of all crashes occur during clear, dry weather conditions with daylight or well-lit road segments.</strong> Only 3 crashes (9.7%) occurred during inclement weather (rain or wet conditions). This critical finding indicates that environmental hazards are NOT the primary driver of crashes at this location. Instead, the crash pattern is strongly influenced by <strong>geometric design factors, traffic control operations, intersection sight distance, or driver behavior</strong>. Recommendations should focus on: (1) intersection geometry and sight triangle optimization, (2) evaluation of traffic control device adequacy (signal timing, signage, pavement markings), (3) identification of specific crash clusters by approach leg and maneuver type, and (4) potential driver expectancy issues at this intersection.</p>
        </div>

        <!-- INJURY ANALYSIS -->
        <div class="section-header">Injury Severity Analysis</div>

        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="injuryChart"></canvas>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="footer-content">
                <strong>Henrico County Traffic Engineering Division</strong><br>
                Dashboard Generated: November 6, 2025<br>
                Data Source: VDOT Crash Records Database<br>
                Analysis Period: July 2021 - January 2025<br>
                <em>This analysis is based on reported crash data and is intended to support traffic safety improvements.</em>
            </div>
        </div>
    </div>

    <script>
        // Set Chart.js defaults
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.plugins.legend.labels.padding = 15;

        // Color scheme
        const colors = {
            fatal: '#dc3545',
            serious: '#fd7e14',
            minor: '#ffc107',
            possible: '#17a2b8',
            pdo: '#28a745'
        };

        const chartColors = ['#1e3c72', '#2a5298', '#4a90e2', '#7b68ee', '#ff6b6b', '#ff8c42', '#ffc107'];

        // ===== 1. YEARLY TREND CHART =====
        const yearlyCtx = document.getElementById('yearlyTrendChart').getContext('2d');
        const yearlyData = {
            2021: 1,
            2022: 8,
            2023: 9,
            2024: 11,
            2025: 2
        };

        new Chart(yearlyCtx, {
            type: 'line',
            data: {
                labels: ['2021', '2022', '2023', '2024', '2025*'],
                datasets: [{
                    label: 'Total Crashes',
                    data: [1, 8, 9, 11, 2],
                    borderColor: '#2a5298',
                    backgroundColor: 'rgba(42, 82, 152, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointBackgroundColor: '#2a5298',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Crashes: ' + context.parsed.y;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        padding: 10,
                        titleFont: { size: 12 },
                        bodyFont: { size: 11 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Number of Crashes' },
                        ticks: { stepSize: 2 }
                    }
                }
            }
        });

        // ===== 2. SEVERITY BY YEAR STACKED BAR =====
        const severityYearCtx = document.getElementById('severityByYearChart').getContext('2d');

        new Chart(severityYearCtx, {
            type: 'bar',
            data: {
                labels: ['2021', '2022', '2023', '2024', '2025*'],
                datasets: [
                    {
                        label: 'Fatal (K)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: colors.fatal
                    },
                    {
                        label: 'Serious (A)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: colors.serious
                    },
                    {
                        label: 'Minor (B)',
                        data: [0, 3, 2, 2, 0],
                        backgroundColor: colors.minor
                    },
                    {
                        label: 'Possible (C)',
                        data: [1, 1, 0, 0, 0],
                        backgroundColor: colors.possible
                    },
                    {
                        label: 'PDO',
                        data: [0, 4, 7, 9, 2],
                        backgroundColor: colors.pdo
                    }
                ]
            },
            options: {
                indexAxis: undefined,
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.parsed.y;
                                const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return context.dataset.label + ': ' + value + ' (' + pct + '%)';
                            }
                        }
                    }
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true }
                }
            }
        });

        // ===== 3. SEVERITY DISTRIBUTION DONUT =====
        const severityCtx = document.getElementById('severityChart').getContext('2d');

        new Chart(severityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Fatal (K)', 'Serious (A)', 'Minor (B)', 'Possible (C)', 'PDO'],
                datasets: [{
                    data: [0, 0, 7, 1, 22],
                    backgroundColor: [colors.fatal, colors.serious, colors.minor, colors.possible, colors.pdo],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 20,
                            font: { size: 12 },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, i) => ({
                                    text: label + ': ' + data.datasets[0].data[i] + ' (' + ((data.datasets[0].data[i]/31)*100).toFixed(1) + '%)',
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = ((value / 31) * 100).toFixed(1);
                                return context.label + ': ' + value + ' crashes (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // ===== 4. COLLISION TYPE HORIZONTAL BAR =====
        const collisionCtx = document.getElementById('collisionTypeChart').getContext('2d');

        new Chart(collisionCtx, {
            type: 'bar',
            data: {
                labels: ['Angle', 'Rear End', 'Sideswipe', 'Other'],
                datasets: [{
                    label: 'Number of Crashes',
                    data: [14, 7, 3, 1],
                    backgroundColor: ['#1e3c72', '#2a5298', '#4a90e2', '#7b68ee']
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.x;
                                const percentage = ((value / 31) * 100).toFixed(1);
                                return 'Crashes: ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Number of Crashes' }
                    }
                }
            }
        });

        // ===== 5. WEATHER CONDITIONS =====
        const weatherCtx = document.getElementById('weatherChart').getContext('2d');

        new Chart(weatherCtx, {
            type: 'doughnut',
            data: {
                labels: ['Clear (No Adverse)', 'Rain', 'Other/Unknown'],
                datasets: [{
                    data: [28, 3, 0],
                    backgroundColor: ['#28a745', '#4a90e2', '#cccccc']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, i) => ({
                                    text: label + ': ' + data.datasets[0].data[i] + ' (' + ((data.datasets[0].data[i]/31)*100).toFixed(1) + '%)',
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = ((value / 31) * 100).toFixed(1);
                                return context.label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // ===== 6. LIGHT CONDITIONS =====
        const lightCtx = document.getElementById('lightChart').getContext('2d');

        new Chart(lightCtx, {
            type: 'doughnut',
            data: {
                labels: ['Daylight', 'Dark (Lit)', 'Dark (Unlit)', 'Dawn/Dusk', 'Unknown'],
                datasets: [{
                    data: [23, 2, 5, 0, 1],
                    backgroundColor: ['#ffc107', '#4a90e2', '#2a5298', '#ff6b6b', '#cccccc']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, i) => ({
                                    text: label + ': ' + data.datasets[0].data[i] + ' (' + ((data.datasets[0].data[i]/31)*100).toFixed(1) + '%)',
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = ((value / 31) * 100).toFixed(1);
                                return context.label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // ===== 7. SURFACE CONDITIONS =====
        const surfaceCtx = document.getElementById('surfaceChart').getContext('2d');

        new Chart(surfaceCtx, {
            type: 'doughnut',
            data: {
                labels: ['Dry', 'Wet', 'Ice/Snow', 'Unknown/Other'],
                datasets: [{
                    data: [28, 3, 0, 0],
                    backgroundColor: ['#28a745', '#4a90e2', '#cccccc', '#999999']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, i) => ({
                                    text: label + ': ' + data.datasets[0].data[i] + ' (' + ((data.datasets[0].data[i]/31)*100).toFixed(1) + '%)',
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = ((value / 31) * 100).toFixed(1);
                                return context.label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // ===== 8. INJURY ANALYSIS BAR =====
        const injuryCtx = document.getElementById('injuryChart').getContext('2d');

        new Chart(injuryCtx, {
            type: 'bar',
            data: {
                labels: ['Total Injury Crashes\n(K+A+B+C)', 'KA Crashes\n(Fatal + Serious)', 'Minor Injury\n(B)', 'Possible Injury\n(C)', 'PDO Only'],
                datasets: [{
                    label: 'Number of Crashes',
                    data: [8, 0, 7, 1, 22],
                    backgroundColor: ['#ff6b6b', colors.serious, colors.minor, colors.possible, colors.pdo]
                }]
            },
            options: {
                indexAxis: undefined,
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const percentage = ((value / 31) * 100).toFixed(1);
                                return 'Crashes: ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Number of Crashes' }
                    }
                }
            }
        });
    </script>
</body>
</html>
